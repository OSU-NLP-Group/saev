
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://osu-nlp-group.github.io/saev/api/api/nn/modeling/">
      
      
        <link rel="prev" href="../saev.nn/">
      
      
        <link rel="next" href="../objectives/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>saev.nn.modeling - saev</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#saev.nn.modeling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="saev" class="md-header__button md-logo" aria-label="saev" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            saev
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              saev.nn.modeling
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../users/guide/" class="md-tabs__link">
          
  
  
    
  
  Users

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../developers/contributing/" class="md-tabs__link">
          
  
  
    
  
  Developers

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../saev/" class="md-tabs__link">
          
  
  
    
  
  API

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="saev" class="md-nav__button md-logo" aria-label="saev" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    saev
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Users
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Users
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../users/sweeps/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sweeps
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Developers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Developers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developers/contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developers/protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shard Protocol
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developers/disk-layout/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Disk Layout
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../developers/datapoint-init/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Datapoint Initialization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../saev/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../colors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.colors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.configs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/saev.data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/bird_mae/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.bird_mae
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/buffers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.buffers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/clip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.clip
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dinov2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.dinov2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/dinov3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.dinov3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/fake_clip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.fake_clip
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/indexed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.indexed
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.models
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/ordered/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.ordered
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/pe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.pe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/shards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.shards
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/shuffled/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.shuffled
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/siglip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.siglip
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data/transforms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.data.transforms
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../disk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.disk
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../framework/saev.framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.framework
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../framework/inference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.framework.inference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../framework/shards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.framework.shards
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../framework/train/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.framework.train
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../helpers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.helpers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../saev.nn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.nn
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    saev.nn.modeling
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.nn.modeling
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling" class="md-nav__link">
    <span class="md-ellipsis">
      
        modeling
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.AuxK" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuxK
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.BatchTopK" class="md-nav__link">
    <span class="md-ellipsis">
      
        BatchTopK
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BatchTopK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.BatchTopK.top_k" class="md-nav__link">
    <span class="md-ellipsis">
      
        top_k
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.BatchTopKActivation" class="md-nav__link">
    <span class="md-ellipsis">
      
        BatchTopKActivation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BatchTopKActivation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.BatchTopKActivation.forward" class="md-nav__link">
    <span class="md-ellipsis">
      
        forward
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.NoAux" class="md-nav__link">
    <span class="md-ellipsis">
      
        NoAux
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.NoSparsity" class="md-nav__link">
    <span class="md-ellipsis">
      
        NoSparsity
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.Relu" class="md-nav__link">
    <span class="md-ellipsis">
      
        Relu
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder" class="md-nav__link">
    <span class="md-ellipsis">
      
        SparseAutoencoder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SparseAutoencoder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder.EncodeOut" class="md-nav__link">
    <span class="md-ellipsis">
      
        EncodeOut
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder.Output" class="md-nav__link">
    <span class="md-ellipsis">
      
        Output
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder.decode" class="md-nav__link">
    <span class="md-ellipsis">
      
        decode
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder.forward" class="md-nav__link">
    <span class="md-ellipsis">
      
        forward
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder.normalize_w_dec" class="md-nav__link">
    <span class="md-ellipsis">
      
        normalize_w_dec
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoder.remove_parallel_grads" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_parallel_grads
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        SparseAutoencoderConfig
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SparseAutoencoderConfig">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.activation" class="md-nav__link">
    <span class="md-ellipsis">
      
        activation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.d_model" class="md-nav__link">
    <span class="md-ellipsis">
      
        d_model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.d_sae" class="md-nav__link">
    <span class="md-ellipsis">
      
        d_sae
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.normalize_w_dec" class="md-nav__link">
    <span class="md-ellipsis">
      
        normalize_w_dec
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.reinit_blend" class="md-nav__link">
    <span class="md-ellipsis">
      
        reinit_blend
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.reinit_enc_dec_tranpose" class="md-nav__link">
    <span class="md-ellipsis">
      
        reinit_enc_dec_tranpose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.SparseAutoencoderConfig.remove_parallel_grads" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_parallel_grads
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.TopK" class="md-nav__link">
    <span class="md-ellipsis">
      
        TopK
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TopK">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.TopK.top_k" class="md-nav__link">
    <span class="md-ellipsis">
      
        top_k
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.TopKActivation" class="md-nav__link">
    <span class="md-ellipsis">
      
        TopKActivation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TopKActivation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#saev.nn.modeling.TopKActivation.forward" class="md-nav__link">
    <span class="md-ellipsis">
      
        forward
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.dump" class="md-nav__link">
    <span class="md-ellipsis">
      
        dump
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#saev.nn.modeling.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../objectives/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.nn.objectives
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/saev.utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.utils.monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/scheduling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.utils.scheduling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/statistics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.utils.statistics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/wandb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.utils.wandb
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../viz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    saev.viz
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../../saev/" class="md-path__link">
          
  <span class="md-ellipsis">
    API
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>saev.nn.modeling</h1>

<div class="doc doc-object doc-module">



<a id="saev.nn.modeling"></a>
    <div class="doc doc-contents first">

        <p>Neural network architectures for sparse autoencoders.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.AuxK" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">AuxK</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;auxk&#39;</span><span class="p">,</span> <span class="n">k_aux</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.AuxK" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>AuxK auxiliary reconstruction loss for dead latents.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.BatchTopK" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">BatchTopK</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;batch-top-k&#39;</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">=</span><span class="n">NoSparsity</span><span class="p">(),</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">aux</span><span class="o">=</span><span class="n">AuxK</span><span class="p">())</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.BatchTopK" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">













<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.BatchTopK.top_k" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">top_k</span> <span class="o">=</span> <span class="mi">32</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.BatchTopK.top_k" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>How many values are allowed to be non-zero per sample in the batch.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.BatchTopKActivation" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">BatchTopKActivation</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.BatchTopKActivation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>



        <p>BatchTopK activation and inference-time threshold for sparse autoencoders.</p>
<p>This module implements a BatchTopK nonlinearity that enforces a fixed sparsity budget across a batch, together with an inference-time approximation that replaces the batch-coupled operation with a simple elementwise threshold.</p>
<p>Training mode (model.train()):
    Given pre-activation codes x with shape [batch, d_sae], the BatchTopK activation flattens the batch to shape [batch * d_sae], selects the largest (batch * top_k) entries by value, and sets all other entries to zero. This enforces an average of exactly <code>top_k</code> active features per example while allowing the "activation budget" to move between examples in the batch.</p>
<pre><code>During training, we also estimate an inference threshold theta that approximates the effective cutoff induced by BatchTopK. For each batch, we compute the minimum positive activation that survives the BatchTopK mask and update an exponential moving average of this quantity. This running estimate plays the same role as BatchNorm running statistics: it is updated only in training mode and treated as fixed at inference.
</code></pre>
<p>Eval mode (model.eval()):
    At inference time we do not apply a batch-coupled top-k, since that would make each example depend on the rest of the eval batch. Instead, we use the stored running threshold theta to define a JumpReLU nonlinearity:</p>
<pre><code>    y = x if x &gt; theta else 0

applied elementwise and independently to each example. This preserves the approximate sparsity level learned during training, but makes the layer deterministic and sample-wise independent for evaluation, probing, and downstream use.
</code></pre>


<details class="inputs" open>
  <summary>Inputs</summary>
  <p>x: Tensor of shape [batch, d_sae] containing pre-activation codes.</p>
</details>

<details class="outputs" open>
  <summary>Outputs</summary>
  <p>Tensor of shape [batch, d_sae] with the same dtype and device as x, where either:
    - in training mode: exactly (batch * top_k) entries are non-zero across the batch due to the BatchTopK mask, or
    - in eval mode: entries are zeroed by an elementwise JumpReLU with the learned threshold theta.</p>
</details>







                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">BatchTopK</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="saev.nn.modeling.BatchTopKActivation.forward" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.BatchTopKActivation.forward" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply top-k activation to each sample in the batch.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch d_sae&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch d_sae&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply top-k activation to each sample in the batch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">bsz</span><span class="p">,</span> <span class="n">d_sae</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x_flat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">bsz</span><span class="p">,</span> <span class="n">d_sae</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span> <span class="o">*</span> <span class="n">bsz</span><span class="p">,</span> <span class="n">d_sae</span> <span class="o">*</span> <span class="n">bsz</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">x_flat</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_flat</span><span class="p">)</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">momentum</span><span class="p">)</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">momentum</span> <span class="o">*</span> <span class="n">pos</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.NoAux" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">NoAux</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;no-aux&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.NoAux" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>No auxiliary loss (e.g., for ReLU).</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.NoSparsity" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">NoSparsity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;no-sparsity&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.NoSparsity" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>No explicit sparsity penalty (e.g. for TopK/BatchTopK where k controls sparsity).</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.Relu" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Relu</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">=</span><span class="n">L1Sparsity</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="mf">0.0004</span><span class="p">),</span> <span class="n">aux</span><span class="o">=</span><span class="n">NoAux</span><span class="p">())</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.Relu" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Vanilla ReLU</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.SparseAutoencoder" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">SparseAutoencoder</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.SparseAutoencoder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>



        <p>Sparse auto-encoder (SAE)</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">SparseAutoencoderConfig</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sae&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_uniform_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">d_sae</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">d_model</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_dec</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">d_model</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">normalize_w_dec</span><span class="p">()</span>

    <span class="c1"># Initialize W_enc to the transpose of W_dec.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">W_enc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">b_enc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">d_sae</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="saev.nn.modeling.SparseAutoencoder.EncodeOut" class="doc doc-heading">
            <code>EncodeOut</code>


<a href="#saev.nn.modeling.SparseAutoencoder.EncodeOut" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>



        <p>Outputs of encode: pre-activations and activated latents.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="saev.nn.modeling.SparseAutoencoder.Output" class="doc doc-heading">
            <code>Output</code>


<a href="#saev.nn.modeling.SparseAutoencoder.Output" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>



        <p>Full SAE forward outputs for objectives and metrics.</p>











<div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="saev.nn.modeling.SparseAutoencoder.decode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">decode</span><span class="p">(</span><span class="n">f_x</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefixes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.SparseAutoencoder.decode" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Decode latent features to reconstructions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>f_x</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Float">Float</span>[<span title="torch.Tensor">Tensor</span>, &#39;batch d_sae&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Latent features of shape (batch, d_sae)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefixes</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="torch.Tensor">Tensor</span>, &#39; n_prefixes&#39;] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional tensor of prefix lengths for Matryoshka decoding.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="jaxtyping.Float">Float</span>[<span title="torch.Tensor">Tensor</span>, &#39;batch n_prefixes d_model&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Matryoshka reconstructions (batch, n_prefixes, d_model).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">f_x</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch d_sae&quot;</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">prefixes</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot; n_prefixes&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch n_prefixes d_model&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode latent features to reconstructions.</span>

<span class="sd">    Args:</span>
<span class="sd">        f_x: Latent features of shape (batch, d_sae)</span>
<span class="sd">        prefixes: Optional tensor of prefix lengths for Matryoshka decoding.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Matryoshka reconstructions (batch, n_prefixes, d_model).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">d_sae</span> <span class="o">=</span> <span class="n">f_x</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Matryoshka cumulative decode</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">f_x</span><span class="o">.</span><span class="n">device</span>
    <span class="k">if</span> <span class="n">prefixes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">d_sae</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="n">prefixes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">prefixes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">d_sae</span>
    <span class="n">prefixes</span> <span class="o">=</span> <span class="n">prefixes</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Build blocks from prefix cuts: [0, cut1), [cut1, cut2), ...</span>
    <span class="n">block_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">prefixes</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span>
        <span class="n">prefixes</span><span class="p">,</span>
    <span class="p">])</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">block_indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">block_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>

    <span class="c1"># Compute block outputs</span>
    <span class="n">block_outputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
        <span class="c1"># Each block uses its portion of f_x and W_dec</span>
        <span class="n">block_f_x</span> <span class="o">=</span> <span class="n">f_x</span><span class="p">[:,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="n">block_W_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Compute block output: (batch, d_sae_block) @ (d_sae_block, d_model) -&gt; (batch, d_model)</span>
        <span class="c1"># Note: W_dec is (d_sae, d_model), so block_W_dec is (block_size, d_model)</span>
        <span class="n">block_output</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
            <span class="n">block_f_x</span><span class="p">,</span>
            <span class="n">block_W_dec</span><span class="p">,</span>
            <span class="s2">&quot;... d_sae_block, d_sae_block d_model -&gt; ... d_model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Add bias only to the first block</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">block_output</span> <span class="o">=</span> <span class="n">block_output</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_dec</span>

        <span class="n">block_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block_output</span><span class="p">)</span>

    <span class="c1"># Cumulative sum to get prefix reconstructions</span>
    <span class="n">x_hats</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">block_outputs</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># (sam) This is clearly wrong. Needs to be cleaned up.</span>
    <span class="k">return</span> <span class="n">x_hats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="saev.nn.modeling.SparseAutoencoder.forward" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.SparseAutoencoder.forward" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Given x, calculates the reconstructed x_hat and the intermediate activations f_x.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Float">Float</span>[<span title="torch.Tensor">Tensor</span>, &#39;batch d_model&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a batch of transformer activations.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch d_model&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Output</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given x, calculates the reconstructed x_hat and the intermediate activations f_x.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        x: a batch of transformer activations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x_hats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">f_x</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span><span class="n">h_x</span><span class="o">=</span><span class="n">enc</span><span class="o">.</span><span class="n">h_x</span><span class="p">,</span> <span class="n">f_x</span><span class="o">=</span><span class="n">enc</span><span class="o">.</span><span class="n">f_x</span><span class="p">,</span> <span class="n">x_hats</span><span class="o">=</span><span class="n">x_hats</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="saev.nn.modeling.SparseAutoencoder.normalize_w_dec" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalize_w_dec</span><span class="p">()</span></code>

<a href="#saev.nn.modeling.SparseAutoencoder.normalize_w_dec" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set W_dec to unit-norm columns.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_w_dec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set W_dec to unit-norm columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">normalize_w_dec</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="saev.nn.modeling.SparseAutoencoder.remove_parallel_grads" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_parallel_grads</span><span class="p">()</span></code>

<a href="#saev.nn.modeling.SparseAutoencoder.remove_parallel_grads" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update grads so that they remove the parallel component</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_parallel_grads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update grads so that they remove the parallel component</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">remove_parallel_grads</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">grad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">parallel_component</span> <span class="o">=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">grad</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="s2">&quot;d_sae d_model, d_sae d_model -&gt; d_sae&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">norm_sq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">parallel_component</span><span class="p">)</span>
    <span class="n">nonzero</span> <span class="o">=</span> <span class="n">norm_sq</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">scales</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="n">parallel_component</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm_sq</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">grad</span> <span class="o">-=</span> <span class="n">einops</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span>
        <span class="n">scales</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W_dec</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="s2">&quot;d_sae, d_sae d_model -&gt; d_sae d_model&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.SparseAutoencoderConfig" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">SparseAutoencoderConfig</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">d_sae</span><span class="o">=</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">TopK</span><span class="p">(),</span> <span class="n">reinit_blend</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">reinit_enc_dec_tranpose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">remove_parallel_grads</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalize_w_dec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">













<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.activation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">activation</span> <span class="o">=</span> <span class="n">TopK</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.activation" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Activation function.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.d_model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">d_model</span> <span class="o">=</span> <span class="mi">1024</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.d_model" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Size of x.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.d_sae" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">d_sae</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">16</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.d_sae" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Number of features in SAE latent space; size of f(x).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.normalize_w_dec" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalize_w_dec</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.normalize_w_dec" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Whether to make sure W_dec has unit norm columns. See <a href="https://transformer-circuits.pub/2023/monosemantic-features/index.html#appendix-autoencoder">Towards Monosemanticity; Appendix "Advice for Training Sparse Autoencoders: Autoencoder Architecture"</a>.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.reinit_blend" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reinit_blend</span> <span class="o">=</span> <span class="mf">0.8</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.reinit_blend" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.reinit_enc_dec_tranpose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reinit_enc_dec_tranpose</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.reinit_enc_dec_tranpose" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.SparseAutoencoderConfig.remove_parallel_grads" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_parallel_grads</span> <span class="o">=</span> <span class="kc">True</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.SparseAutoencoderConfig.remove_parallel_grads" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Whether to remove gradients parallel to W_dec columns (which will be ignored because we force the columns to have unit norm). See <a href="https://transformer-circuits.pub/2023/monosemantic-features/index.html#appendix-autoencoder-optimization">Towards Monosemanticity; Appendix "Advice for Training Sparse Autoencoders: Autoencoder Architecture"</a> for discussion by Anthropic.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.TopK" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">TopK</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;top-k&#39;</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">sparsity</span><span class="o">=</span><span class="n">NoSparsity</span><span class="p">(),</span> <span class="n">aux</span><span class="o">=</span><span class="n">AuxK</span><span class="p">())</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#saev.nn.modeling.TopK" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">













<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="saev.nn.modeling.TopK.top_k" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">top_k</span> <span class="o">=</span> <span class="mi">32</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#saev.nn.modeling.TopK.top_k" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>How many values are allowed to be non-zero.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="saev.nn.modeling.TopKActivation" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">TopKActivation</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.TopKActivation" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.nn.Module">Module</span></code></p>



        <p>Top-K activation function. For use as activation function of sparse encoder.</p>








                  <details class="mkdocstrings-source">
                    <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">TopK</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="saev.nn.modeling.TopKActivation.forward" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.TopKActivation.forward" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply top-k activation to the input tensor.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch d_sae&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;batch d_sae&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply top-k activation to the input tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bsz</span><span class="p">,</span> <span class="n">d_sae</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span> <span class="n">d_sae</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="saev.nn.modeling.dump" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dump</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">sae</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.dump" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Save an SAE checkpoint to disk along with configuration, using the <a href="https://docs.kidger.site/equinox/examples/serialisation">trick from equinox</a>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>fpath</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>filepath to save checkpoint to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sae</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SparseAutoencoder(cfg) (saev.nn.modeling.SparseAutoencoder)" href="#saev.nn.modeling.SparseAutoencoder">SparseAutoencoder</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>sparse autoencoder checkpoint to save.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dump</span><span class="p">(</span><span class="n">fpath</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sae</span><span class="p">:</span> <span class="n">SparseAutoencoder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save an SAE checkpoint to disk along with configuration, using the [trick from equinox](https://docs.kidger.site/equinox/examples/serialisation).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        fpath: filepath to save checkpoint to.</span>
<span class="sd">        sae: sparse autoencoder checkpoint to save.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Custom serialization to handle activation object</span>
    <span class="n">cfg_dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">asdict</span><span class="p">(</span><span class="n">sae</span><span class="o">.</span><span class="n">cfg</span><span class="p">)</span>
    <span class="c1"># Replace activation dict with custom format</span>
    <span class="n">activation</span> <span class="o">=</span> <span class="n">sae</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">activation</span>
    <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_serialize_dataclass</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>

    <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">SCHEMA_VERSION</span><span class="p">,</span>
        <span class="s2">&quot;cfg&quot;</span><span class="p">:</span> <span class="n">cfg_dict</span><span class="p">,</span>
        <span class="s2">&quot;commit&quot;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">current_git_commit</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lib&quot;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">fpath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
    <span class="n">fpath</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">jdump</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="n">orjson</span><span class="o">.</span><span class="n">OPT_APPEND_NEWLINE</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sae</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">fd</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="saev.nn.modeling.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span></code>

<a href="#saev.nn.modeling.load" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Loads a sparse autoencoder from disk.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/saev/nn/modeling.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@beartype</span><span class="o">.</span><span class="n">beartype</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">fpath</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SparseAutoencoder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a sparse autoencoder from disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="k">if</span> <span class="s2">&quot;schema&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
        <span class="c1"># Original, pre-schema format: just raw config parameters</span>
        <span class="c1"># Remove old parameters that no longer exist</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;sparsity_coeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ghost_grads&quot;</span><span class="p">,</span>
            <span class="s2">&quot;l1_coeff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;use_ghost_grads&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Legacy format - create SparseAutoencoderConfig with Relu activation</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;d_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;d_vit&quot;</span><span class="p">)</span>
        <span class="n">cfg_kwargs</span> <span class="o">=</span> <span class="n">_normalize_cfg_kwargs</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">SparseAutoencoderConfig</span><span class="p">(</span><span class="o">**</span><span class="n">cfg_kwargs</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">Relu</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Schema version 1: A cautionary tale of poor version management</span>
        <span class="c1">#</span>
        <span class="c1"># This schema version unfortunately has TWO incompatible formats because we made breaking changes without incrementing the schema version. This is exactly what schema versioning is supposed to prevent!</span>
        <span class="c1">#</span>
        <span class="c1"># Format 1A (original): cls field contains activation type (&quot;Relu&quot;, &quot;TopK&quot;, etc.)</span>
        <span class="c1"># Format 1B (later): cls field is &quot;SparseAutoencoderConfig&quot; and activation is a dict</span>
        <span class="c1">#</span>
        <span class="c1"># The complex logic below exists to handle both formats. This should have been avoided by incrementing to schema version 2 when we changed the format.</span>
        <span class="c1">#</span>
        <span class="c1"># Apologies from Sam for this mess - proper schema versioning discipline would have prevented this confusing situation. Every breaking change should increment the version number!</span>

        <span class="n">cls_name</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cls&quot;</span><span class="p">,</span> <span class="s2">&quot;SparseAutoencoderConfig&quot;</span><span class="p">)</span>
        <span class="n">cfg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;cfg&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cls_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Relu&quot;</span><span class="p">,</span> <span class="s2">&quot;TopK&quot;</span><span class="p">,</span> <span class="s2">&quot;BatchTopK&quot;</span><span class="p">]:</span>
            <span class="c1"># Format 1A: Old format where cls indicates the activation type</span>
            <span class="n">activation_cls</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">cls_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cls_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TopK&quot;</span><span class="p">,</span> <span class="s2">&quot;BatchTopK&quot;</span><span class="p">]:</span>
                <span class="n">activation</span> <span class="o">=</span> <span class="n">activation_cls</span><span class="p">(</span><span class="n">top_k</span><span class="o">=</span><span class="n">cfg_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;top_k&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">activation</span> <span class="o">=</span> <span class="n">activation_cls</span><span class="p">()</span>
            <span class="n">cfg_kwargs</span> <span class="o">=</span> <span class="n">_normalize_cfg_kwargs</span><span class="p">(</span><span class="n">cfg_dict</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">SparseAutoencoderConfig</span><span class="p">(</span><span class="o">**</span><span class="n">cfg_kwargs</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Format 1B: Newer format with activation as dict</span>
            <span class="k">if</span> <span class="s2">&quot;activation&quot;</span> <span class="ow">in</span> <span class="n">cfg_dict</span><span class="p">:</span>
                <span class="n">activation_info</span> <span class="o">=</span> <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span>
                <span class="n">activation_cls</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">activation_info</span><span class="p">[</span><span class="s2">&quot;cls&quot;</span><span class="p">]]</span>
                <span class="n">activation</span> <span class="o">=</span> <span class="n">activation_cls</span><span class="p">(</span><span class="o">**</span><span class="n">activation_info</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">])</span>
                <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activation</span>
            <span class="n">cfg_kwargs</span> <span class="o">=</span> <span class="n">_normalize_cfg_kwargs</span><span class="p">(</span><span class="n">cfg_dict</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">SparseAutoencoderConfig</span><span class="p">(</span><span class="o">**</span><span class="n">cfg_kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
        <span class="c1"># Schema version 2: cleaner format with activation serialization</span>
        <span class="n">cfg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;cfg&quot;</span><span class="p">])</span>
        <span class="n">activation_info</span> <span class="o">=</span> <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">_deserialize_dataclass_payload</span><span class="p">(</span>
            <span class="n">activation_info</span><span class="p">,</span> <span class="n">allow_legacy_nested</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activation</span>
        <span class="n">cfg_kwargs</span> <span class="o">=</span> <span class="n">_normalize_cfg_kwargs</span><span class="p">(</span><span class="n">cfg_dict</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">SparseAutoencoderConfig</span><span class="p">(</span><span class="o">**</span><span class="n">cfg_kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">cfg_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;cfg&quot;</span><span class="p">])</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">_deserialize_dataclass_payload</span><span class="p">(</span>
            <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span> <span class="n">allow_legacy_nested</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">cfg_dict</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">activation</span>
        <span class="n">cfg_kwargs</span> <span class="o">=</span> <span class="n">_normalize_cfg_kwargs</span><span class="p">(</span><span class="n">cfg_dict</span><span class="p">)</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">SparseAutoencoderConfig</span><span class="p">(</span><span class="o">**</span><span class="n">cfg_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown schema version: </span><span class="si">{</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;schema&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">SparseAutoencoder</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../saev.nn/" class="md-footer__link md-footer__link--prev" aria-label="Previous: saev.nn">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                saev.nn
              </div>
            </div>
          </a>
        
        
          
          <a href="../objectives/" class="md-footer__link md-footer__link--next" aria-label="Next: saev.nn.objectives">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                saev.nn.objectives
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/OSU-NLP-Group/saev" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.path", "navigation.indexes", "navigation.expand", "toc.follow", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy", "navigation.footer", "content.action.edit"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>